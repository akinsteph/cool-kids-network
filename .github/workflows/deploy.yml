name: Deploy to Public site

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
    - name: Install dependencies
      run: composer install --no-dev --optimize-autoloader
    - name: Deploy to Hostinger
      env:
        HOSTINGER_SSH_KEY: ${{ secrets.HOSTINGER_SSH_KEY }}
        HOSTINGER_USER: ${{ secrets.HOSTINGER_USER }}
        HOSTINGER_HOST: ${{ secrets.HOSTINGER_HOST }}
        HOSTINGER_PATH: ${{ secrets.HOSTINGER_PATH }}
      run: |
        echo "$HOSTINGER_SSH_KEY" > deploy_key
        chmod 600 deploy_key
        rsync -avz -r -e "ssh -i deploy_key -o StrictHostKeyChecking=no"  --exclude={'.git','.github','wp-content/uploads','phpunit.xml','wp-content/themes/coolkidsnetwork/tests','phpcs.xml','deploy_key','.env', 'composer.lock', 'composer.json'} --update \
          ./ ${HOSTINGER_USER}@${HOSTINGER_HOST}:${HOSTINGER_PATH}
        ssh -i deploy_key -o StrictHostKeyChecking=no ${HOSTINGER_USER}@${HOSTINGER_HOST} \
          "cd ${HOSTINGER_PATH} && \
          wp core update --allow-root && \
          wp plugin update --all --allow-root && \
          wp theme update --all --allow-root && \
          wp theme activate coolkidsnetwork --allow-root"
        rm -f deploy_key